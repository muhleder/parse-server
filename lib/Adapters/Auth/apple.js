"use strict";

// Apple SignIn Auth
// https://developer.apple.com/documentation/signinwithapplerestapi
const Parse = require('parse/node').Parse;

const httpsRequest = require('./httpsRequest');

const NodeRSA = require('node-rsa');

const jwt = require('jsonwebtoken');

const TOKEN_ISSUER = 'https://appleid.apple.com';
let currentKey;

const getApplePublicKey = async keyId => {
  let data;

  try {
    data = await httpsRequest.get('https://appleid.apple.com/auth/keys');
  } catch (e) {
    if (currentKey) {
      return currentKey;
    }

    throw e;
  }

  const key = data.keys.find(key => key.kid === keyId);

  if (!key) {
    throw Error('Public key with matching key ID to token not found');
  }

  const pubKey = new NodeRSA();
  pubKey.importKey({
    n: Buffer.from(key.n, 'base64'),
    e: Buffer.from(key.e, 'base64')
  }, 'components-public');
  currentKey = pubKey.exportKey(['public']);
  return currentKey;
};

const getKeyAndAlgoFromToken = token => {
  const decodedToken = jwt.decode(token, {
    complete: true
  });

  if (!decodedToken) {
    throw Error('provided token does not decode as JWT');
  }

  const keyId = decodedToken.header.kid;
  const algo = decodedToken.header.alg;
  return {
    keyId,
    algo
  };
};

const verifyIdToken = async ({
  token,
  id
}) => {
  if (!token) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'id token is invalid for this user.');
  }

  const decodedToken = getKeyAndAlgoFromToken(token);
  const applePublicKey = await getApplePublicKey(decodedToken.keyId);
  const jwtClaims = jwt.verify(token, applePublicKey, {
    algorithms: decodedToken.algo
  });

  if (jwtClaims.iss !== TOKEN_ISSUER) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `id token not issued by correct OpenID provider - expected: ${TOKEN_ISSUER} | from: ${jwtClaims.iss}`);
  }

  if (jwtClaims.sub !== id) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `auth data is invalid for this user.`);
  }

  return jwtClaims;
}; // Returns a promise that fulfills if this id token is valid


function validateAuthData(authData) {
  return verifyIdToken(authData);
} // Returns a promise that fulfills if this app id is valid.


function validateAppId() {
  return Promise.resolve();
}

module.exports = {
  validateAppId,
  validateAuthData
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BZGFwdGVycy9BdXRoL2FwcGxlLmpzIl0sIm5hbWVzIjpbIlBhcnNlIiwicmVxdWlyZSIsImh0dHBzUmVxdWVzdCIsIk5vZGVSU0EiLCJqd3QiLCJUT0tFTl9JU1NVRVIiLCJjdXJyZW50S2V5IiwiZ2V0QXBwbGVQdWJsaWNLZXkiLCJrZXlJZCIsImRhdGEiLCJnZXQiLCJlIiwia2V5Iiwia2V5cyIsImZpbmQiLCJraWQiLCJFcnJvciIsInB1YktleSIsImltcG9ydEtleSIsIm4iLCJCdWZmZXIiLCJmcm9tIiwiZXhwb3J0S2V5IiwiZ2V0S2V5QW5kQWxnb0Zyb21Ub2tlbiIsInRva2VuIiwiZGVjb2RlZFRva2VuIiwiZGVjb2RlIiwiY29tcGxldGUiLCJoZWFkZXIiLCJhbGdvIiwiYWxnIiwidmVyaWZ5SWRUb2tlbiIsImlkIiwiT0JKRUNUX05PVF9GT1VORCIsImFwcGxlUHVibGljS2V5Iiwiand0Q2xhaW1zIiwidmVyaWZ5IiwiYWxnb3JpdGhtcyIsImlzcyIsInN1YiIsInZhbGlkYXRlQXV0aERhdGEiLCJhdXRoRGF0YSIsInZhbGlkYXRlQXBwSWQiLCJQcm9taXNlIiwicmVzb2x2ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUVBLE1BQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLFlBQUQsQ0FBUCxDQUFzQkQsS0FBcEM7O0FBQ0EsTUFBTUUsWUFBWSxHQUFHRCxPQUFPLENBQUMsZ0JBQUQsQ0FBNUI7O0FBQ0EsTUFBTUUsT0FBTyxHQUFHRixPQUFPLENBQUMsVUFBRCxDQUF2Qjs7QUFDQSxNQUFNRyxHQUFHLEdBQUdILE9BQU8sQ0FBQyxjQUFELENBQW5COztBQUVBLE1BQU1JLFlBQVksR0FBRywyQkFBckI7QUFFQSxJQUFJQyxVQUFKOztBQUVBLE1BQU1DLGlCQUFpQixHQUFHLE1BQU1DLEtBQU4sSUFBZTtBQUN2QyxNQUFJQyxJQUFKOztBQUNBLE1BQUk7QUFDRkEsSUFBQUEsSUFB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U0FBU0ssZ0JBQVQsQ0FBMEJDLFFBQTFCLEVBQW9DO0FBQ2xDLFNBQU9WLGFBQWEsQ0FBQ1UsUUFBRCxDQUFwQjtBQUNELEMsQ0FFRDs7O0FBQ0EsU0FBU0MsYUFBVCxHQUF5QjtBQUN2QixTQUFPQyxPQUFPLENBQUNDLE9BQVIsRUFBUDtBQUNEOztBQUVEQyxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDZkosRUFBQUEsYUFEZTtBQUVmRixFQUFBQTtBQUZlLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQXBwbGUgU2lnbkluIEF1dGhcbi8vIGh0dHBzOi8vZGV2ZWxvcGVyLmFwcGxlLmNvbS9kb2N1bWVudGF0aW9uL3NpZ25pbndpdGhhcHBsZXJlc3RhcGlcblxuY29uc3QgUGFyc2UgPSByZXF1aXJlKCdwYXJzZS9ub2RlJykuUGFyc2U7XG5jb25zdCBodHRwc1JlcXVlc3QgPSByZXF1aXJlKCcuL2h0dHBzUmVxdWVzdCcpO1xuY29uc3QgTm9kZVJTQSA9IHJlcXVpcmUoJ25vZGUtcnNhJyk7XG5jb25zdCBqd3QgPSByZXF1aXJlKCdqc29ud2VidG9rZW4nKTtcblxuY29uc3QgVE9LRU5fSVNTVUVSID0gJ2h0dHBzOi8vYXBwbGVpZC5hcHBsZS5jb20nO1xuXG5sZXQgY3VycmVudEtleTtcblxuY29uc3QgZ2V0QXBwbGVQdWJsaWNLZXkgPSBhc3luYyBrZXlJZCA9PiB7XG4gIGxldCBkYXRhO1xuICB0cnkge1xuICAgIGRhdGEgPSBhd2FpdCBodHRwc1JlcXVlc3QuZ2V0KCdodHRwczovL2FwcGxlaWQuYXBwbGUuY29tL2F1dGgva2V5cycpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKGN1cnJlbnRLZXkpIHtcbiAgICAgIHJldHVybiBjdXJyZW50S2V5O1xuICAgIH1cbiAgICB0aHJvdyBlO1xuICB9XG5cbiAgY29uc3Qga2V5ID0gZGF0YS5rZXlzLmZpbmQoa2V5ID0+IGtleS5raWQgPT09IGtleUlkKTtcblxuICBpZiAoIWtleSkge1xuICAgIHRocm93IEVycm9yKCdQdWJsaWMga2V5IHdpdGggbWF0Y2hpbmcga2V5IElEIHRvIHRva2VuIG5vdCBmb3VuZCcpO1xuICB9XG5cbiAgY29uc3QgcHViS2V5ID0gbmV3IE5vZGVSU0EoKTtcbiAgcHViS2V5LmltcG9ydEtleShcbiAgICB7IG46IEJ1ZmZlci5mcm9tKGtleS5uLCAnYmFzZTY0JyksIGU6IEJ1ZmZlci5mcm9tKGtleS5lLCAnYmFzZTY0JykgfSxcbiAgICAnY29tcG9uZW50cy1wdWJsaWMnXG4gICk7XG4gIGN1cnJlbnRLZXkgPSBwdWJLZXkuZXhwb3J0S2V5KFsncHVibGljJ10pO1xuICByZXR1cm4gY3VycmVudEtleTtcbn07XG5cbmNvbnN0IGdldEtleUFuZEFsZ29Gcm9tVG9rZW4gPSB0b2tlbiA9PiB7XG4gIGNvbnN0IGRlY29kZWRUb2tlbiA9IGp3dC5kZWNvZGUodG9rZW4sIHsgY29tcGxldGU6IHRydWUgfSk7XG4gIGlmICghZGVjb2RlZFRva2VuKSB7XG4gICAgdGhyb3cgRXJyb3IoJ3Byb3ZpZGVkIHRva2VuIGRvZXMgbm90IGRlY29kZSBhcyBKV1QnKTtcbiAgfVxuICBjb25zdCBrZXlJZCA9IGRlY29kZWRUb2tlbi5oZWFkZXIua2lkO1xuICBjb25zdCBhbGdvID0gZGVjb2RlZFRva2VuLmhlYWRlci5hbGc7XG5cbiAgcmV0dXJuIHsga2V5SWQsIGFsZ28gfTtcbn07XG5cbmNvbnN0IHZlcmlmeUlkVG9rZW4gPSBhc3luYyAoeyB0b2tlbiwgaWQgfSkgPT4ge1xuICBpZiAoIXRva2VuKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgICdpZCB0b2tlbiBpcyBpbnZhbGlkIGZvciB0aGlzIHVzZXIuJ1xuICAgICk7XG4gIH1cblxuICBjb25zdCBkZWNvZGVkVG9rZW4gPSBnZXRLZXlBbmRBbGdvRnJvbVRva2VuKHRva2VuKTtcbiAgY29uc3QgYXBwbGVQdWJsaWNLZXkgPSBhd2FpdCBnZXRBcHBsZVB1YmxpY0tleShkZWNvZGVkVG9rZW4ua2V5SWQpO1xuICBjb25zdCBqd3RDbGFpbXMgPSBqd3QudmVyaWZ5KHRva2VuLCBhcHBsZVB1YmxpY0tleSwge1xuICAgIGFsZ29yaXRobXM6IGRlY29kZWRUb2tlbi5hbGdvLFxuICB9KTtcblxuICBpZiAoand0Q2xhaW1zLmlzcyAhPT0gVE9LRU5fSVNTVUVSKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgIGBpZCB0b2tlbiBub3QgaXNzdWVkIGJ5IGNvcnJlY3QgT3BlbklEIHByb3ZpZGVyIC0gZXhwZWN0ZWQ6ICR7VE9LRU5fSVNTVUVSfSB8IGZyb206ICR7and0Q2xhaW1zLmlzc31gXG4gICAgKTtcbiAgfVxuICBpZiAoand0Q2xhaW1zLnN1YiAhPT0gaWQpIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELFxuICAgICAgYGF1dGggZGF0YSBpcyBpbnZhbGlkIGZvciB0aGlzIHVzZXIuYFxuICAgICk7XG4gIH1cbiAgcmV0dXJuIGp3dENsYWltcztcbn07XG5cbi8vIFJldHVybnMgYSBwcm9taXNlIHRoYXQgZnVsZmlsbHMgaWYgdGhpcyBpZCB0b2tlbiBpcyB2YWxpZFxuZnVuY3Rpb24gdmFsaWRhdGVBdXRoRGF0YShhdXRoRGF0YSkge1xuICByZXR1cm4gdmVyaWZ5SWRUb2tlbihhdXRoRGF0YSk7XG59XG5cbi8vIFJldHVybnMgYSBwcm9taXNlIHRoYXQgZnVsZmlsbHMgaWYgdGhpcyBhcHAgaWQgaXMgdmFsaWQuXG5mdW5jdGlvbiB2YWxpZGF0ZUFwcElkKCkge1xuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICB2YWxpZGF0ZUFwcElkLFxuICB2YWxpZGF0ZUF1dGhEYXRhLFxufTtcbiJdfQ==