"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.ClassesRouter = void 0;

var _PromiseRouter = _interopRequireDefault(require("../PromiseRouter"));

var _rest = _interopRequireDefault(require("../rest"));

var _lodash = _interopRequireDefault(require("lodash"));

var _node = _interopRequireDefault(require("parse/node"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const ALLOWED_GET_QUERY_KEYS = ['keys', 'include', 'readPreference', 'includeReadPreference', 'subqueryReadPreference'];

class ClassesRouter extends _PromiseRouter.default {
  className(req) {
    return req.params.className;
  }

  handleFind(req) {
    const body = Object.assign(req.body, ClassesRouter.JSONFromQuery(req.query));
    const options = ClassesRouter.optionsFromBody(body);

    if (req.config.maxLimit && body.limit > req.config.maxLimit) {
      // Silently replace the limit on the query with the max configured
      options.limit = Number(req.config.maxLimit);
    }

    if (body.redirectClassNameForKey) {
      options.redirectClassNameForKey = String(body.redirectClassNameForKey);
    }

    if (typeof body.where === 'string') {
      body.where = JSON.parse(body.where);
    }

    return _rest.default.find(req.config, req.auth, this.className(req), body.where, options, req.info.clientSDK).then(response => {
      return {
        response: response
      };
    });
  } // Returns a promise for a {response} object.


  handleGet(req) {
    const body = Object.assign(req.body, ClassesRouter.JSONFromQuery(req.query));
    const options = {};

    for (const key of Object.keys(body)) {
      if (ALLOWED_GET_QUERY_KEYS.indexOf(key) === -1) {
        throw new _node.default.Error(_node.default.Error.INVALID_QUERY, 'Improper encode of parameter');
      }
    }

    if (typeof body.keys === 'string') {
      options.keys = body.keys;
    }

    if (body.include) {
      options.include = String(body.include);
    }

    if (typeof body.readPreference === 'string') {
      options.readPreference = body.readPreference;
    }

    if (typeof body.includeReadPreference === 'string') {
      options.includeReadPreference = body.includeReadPreference;
    }

    if (typeof body.subqueryReadPreference === 'string') {
      options.subqueryReadPreference = body.subqueryReadPreference;
    }

    return _rest.default.get(req.config, req.auth, this.className(req), req.params.objectId, options, req.info.clientSDK).then(response => {
      if (!response.results || response.results.length == 0) {
        throw new _node.default.Error(_node.default.Error.OBJECT_NOT_FOUND, 'Object not found.');
      }

      if (this.className(req) === '_User') {
        delete response.results[0].sessionToken;
        const user = response.results[0];

        if (req.auth.user && user.objectId == req.auth.user.id) {
          // Force the session token
          response.results[0].sessionToken = req.info.sessionToken;
        }
      }

      return {
        response: response.results[0]
      };
    });
  }

  handleCreate(req) {
    return _rest.default.create(req.config, req.auth, this.className(req), req.body, req.info.clientSDK);
  }

  handleUpdate(req) {
    const where = {
      objectId: req.params.objectId
    };
    return _rest.default.update(req.config, req.auth, this.className(req), where, req.body, req.info.clientSDK);
  }

  handleDelete(req) {
    return _rest.default.del(req.config, req.auth, this.className(req), req.params.objectId, req.info.clientSDK).then(() => {
      return {
        response: {}
      };
    });
  }

  static JSONFromQuery(query) {
    const json = {};

    for (const [key, value] of _lodash.default.entries(query)) {
      try {
        json[key] = JSON.parse(value);
      } catch (e) {
        json[key] = value;
      }
    }

    return json;
  }

  static optionsFromBody(body) {
    const allowConstraints = ['skip', 'limit', 'order', 'count', 'keys', 'excludeKeys', 'include', 'includeAll', 'redirectClassNameForKey', 'where', 'readPreference', 'includeReadPreference', 'subqueryReadPreference', 'hint', 'explain'];

    for (const key of Object.keys(body)) {
      if (allowConstraints.indexOf(key) === -1) {
        throw new _node.default.Error(_node.default.Error.INVALID_QUERY, `Invalid parameter for query: ${key}`);
      }
    }

    const options = {};

    if (body.skip) {
      options.skip = Number(body.skip);
    }

    if (body.limit || body.limit === 0) {
      options.limit = Number(body.limit);
    } else {
      options.limit = Number(100);
    }

    if (body.order) {
      options.order = String(body.order);
    }

    if (body.count) {
      options.count = true;
    }

    if (typeof body.keys == 'string') {
      options.keys = body.keys;
    }

    if (typeof body.excludeKeys == 'string') {
      options.excludeKeys = body.excludeKeys;
    }

    if (body.include) {
      options.include = String(body.include);
    }

    if (body.includeAll) {
      options.includeAll = true;
    }

    if (typeof body.readPreference === 'string') {
      options.readPreference = body.readPreference;
    }

    if (typeof body.includeReadPreference === 'string') {
      options.includeReadPreference = body.includeReadPreference;
    }

    if (typeof body.subqueryReadPreference === 'string') {
      options.subqueryReadPreference = body.subqueryReadPreference;
    }

    if (body.hint && (typeof body.hint === 'string' || typeof body.hint === 'object')) {
      options.hint = body.hint;
    }

    if (body.explain) {
      options.explain = body.explain;
    }

    return options;
  }

  mountRoutes() {
    this.route('GET', '/classes/:className', req => {
      return this.handleFind(req);
    });
    this.route('GET', '/classes/:className/:objectId', req => {
      return this.handleGet(req);
    });
    this.route('POST', '/classes/:className', req => {
      return this.handleCreate(req);
    });
    this.route('PUT', '/classes/:className/:objectId', req => {
      return this.handleUpdate(req);
    });
    this.route('DELETE', '/classes/:className/:objectId', req => {
      return this.handleDelete(req);
    });
  }

}

exports.ClassesRouter = ClassesRouter;
var _default = ClassesRouter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0NsYXNzZXNSb3V0ZXIuanMiXSwibmFtZXMiOlsiQUxMT1dFRF9HRVRfUVVFUllfS0VZUyIsIkNsYXNzZXNSb3V0ZXIiLCJQcm9taXNlUm91dGVyIiwiY2xhc3NOYW1lIiwicmVxIiwicGFyYW1zIiwiaGFuZGxlRmluZCIsImJvZHkiLCJPYmplY3QiLCJhc3NpZ24iLCJKU09ORnJvbVF1ZXJ5IiwicXVlcnkiLCJvcHRpb25zIiwib3B0aW9uc0Zyb21Cb2R5IiwiY29uZmlnIiwibWF4TGltaXQiLCJsaW1pdCIsIk51bWJlciIsInJlZGlyZWN0Q2xhc3NOYW1lRm9yS2V5IiwiU3RyaW5nIiwid2hlcmUiLCJKU09OIiwicGFyc2UiLCJyZXN0IiwiZmluZCIsImF1dGgiLCJpbmZvIiwiY2xpZW50U0RLIiwidGhlbiIsInJlc3BvbnNlIiwiaGFuZGxlR2V0Iiwia2V5Iiwia2V5cyIsImluZGV4T2YiLCJQYXJzZSIsIkVycm9yIiwiSU5WQUxJRF9RVUVSWSIsImluY2x1ZGUiLCJyZWFkUHJlZmVyZW5jZSIsImluY2x1ZGVSZWFkUHJlZmVyZW5jZSIsInN1YnF1ZXJ5UmVhZFByZWZlcmVuY2UiLCJnZXQiLCJvYmplY3RJZCIsInJlc3VsdHMiLCJsZW5ndGgiLCJPQkpFQ1RfTk9UX0ZPVU5EIiwic2Vzc2lvblRva2VuIiwidXNlciIsImlkIiwiaGFuZGxlQ3JlYXRlIiwiY3JlYXRlIiwiaGFuZGxlVXBkYXRlIiwidXBkYXRlIiwiaGFuZGxlRGVsZXRlIiwiZGVsIiwianNvbiIsInZhbHVlIiwiXyIsImVudHJpZXMiLCJlIiwiYWxsb3dDb25zdHJhaW50cyIsInNraXAiLCJvcmRlciIsImNvdW50IiwiZXhjbHVkZUtleXMiLCJpbmNsdWRlQWxsIiwiaGludCIsImV4cGxhaW4iLCJtb3VudFJvdXRlcyIsInJvdXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxzQkFBc0IsR0FB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S0FBS0UsVUFBTCxDQUFnQkYsR0FBaEIsQ0FBUDtBQUNELEtBRkQ7QUFHQSxTQUFLaUUsS0FBTCxDQUFXLEtBQVgsRUFBa0IsK0JBQWxCLEVBQW1EakUsR0FBRyxJQUFJO0FBQ3hELGFBQU8sS0FBSzBCLFNBQUwsQ0FBZTFCLEdBQWYsQ0FBUDtBQUNELEtBRkQ7QUFHQSxTQUFLaUUsS0FBTCxDQUFXLE1BQVgsRUFBbUIscUJBQW5CLEVBQTBDakUsR0FBRyxJQUFJO0FBQy9DLGFBQU8sS0FBSzZDLFlBQUwsQ0FBa0I3QyxHQUFsQixDQUFQO0FBQ0QsS0FGRDtBQUdBLFNBQUtpRSxLQUFMLENBQVcsS0FBWCxFQUFrQiwrQkFBbEIsRUFBbURqRSxHQUFHLElBQUk7QUFDeEQsYUFBTyxLQUFLK0MsWUFBTCxDQUFrQi9DLEdBQWxCLENBQVA7QUFDRCxLQUZEO0FBR0EsU0FBS2lFLEtBQUwsQ0FBVyxRQUFYLEVBQXFCLCtCQUFyQixFQUFzRGpFLEdBQUcsSUFBSTtBQUMzRCxhQUFPLEtBQUtpRCxZQUFMLENBQWtCakQsR0FBbEIsQ0FBUDtBQUNELEtBRkQ7QUFHRDs7QUE5TzhDOzs7ZUFpUGxDSCxhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2VSb3V0ZXIgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG5pbXBvcnQgcmVzdCBmcm9tICcuLi9yZXN0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgUGFyc2UgZnJvbSAncGFyc2Uvbm9kZSc7XG5cbmNvbnN0IEFMTE9XRURfR0VUX1FVRVJZX0tFWVMgPSBbXG4gICdrZXlzJyxcbiAgJ2luY2x1ZGUnLFxuICAncmVhZFByZWZlcmVuY2UnLFxuICAnaW5jbHVkZVJlYWRQcmVmZXJlbmNlJyxcbiAgJ3N1YnF1ZXJ5UmVhZFByZWZlcmVuY2UnLFxuXTtcblxuZXhwb3J0IGNsYXNzIENsYXNzZXNSb3V0ZXIgZXh0ZW5kcyBQcm9taXNlUm91dGVyIHtcbiAgY2xhc3NOYW1lKHJlcSkge1xuICAgIHJldHVybiByZXEucGFyYW1zLmNsYXNzTmFtZTtcbiAgfVxuXG4gIGhhbmRsZUZpbmQocmVxKSB7XG4gICAgY29uc3QgYm9keSA9IE9iamVjdC5hc3NpZ24oXG4gICAgICByZXEuYm9keSxcbiAgICAgIENsYXNzZXNSb3V0ZXIuSlNPTkZyb21RdWVyeShyZXEucXVlcnkpXG4gICAgKTtcbiAgICBjb25zdCBvcHRpb25zID0gQ2xhc3Nlc1JvdXRlci5vcHRpb25zRnJvbUJvZHkoYm9keSk7XG4gICAgaWYgKHJlcS5jb25maWcubWF4TGltaXQgJiYgYm9keS5saW1pdCA+IHJlcS5jb25maWcubWF4TGltaXQpIHtcbiAgICAgIC8vIFNpbGVudGx5IHJlcGxhY2UgdGhlIGxpbWl0IG9uIHRoZSBxdWVyeSB3aXRoIHRoZSBtYXggY29uZmlndXJlZFxuICAgICAgb3B0aW9ucy5saW1pdCA9IE51bWJlcihyZXEuY29uZmlnLm1heExpbWl0KTtcbiAgICB9XG4gICAgaWYgKGJvZHkucmVkaXJlY3RDbGFzc05hbWVGb3JLZXkpIHtcbiAgICAgIG9wdGlvbnMucmVkaXJlY3RDbGFzc05hbWVGb3JLZXkgPSBTdHJpbmcoYm9keS5yZWRpcmVjdENsYXNzTmFtZUZvcktleSk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgYm9keS53aGVyZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGJvZHkud2hlcmUgPSBKU09OLnBhcnNlKGJvZHkud2hlcmUpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdFxuICAgICAgLmZpbmQoXG4gICAgICAgIHJlcS5jb25maWcsXG4gICAgICAgIHJlcS5hdXRoLFxuICAgICAgICB0aGlzLmNsYXNzTmFtZShyZXEpLFxuICAgICAgICBib2R5LndoZXJlLFxuICAgICAgICBvcHRpb25zLFxuICAgICAgICByZXEuaW5mby5jbGllbnRTREtcbiAgICAgIClcbiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgcmV0dXJuIHsgcmVzcG9uc2U6IHJlc3BvbnNlIH07XG4gICAgICB9KTtcbiAgfVxuXG4gIC8vIFJldHVybnMgYSBwcm9taXNlIGZvciBhIHtyZXNwb25zZX0gb2JqZWN0LlxuICBoYW5kbGVHZXQocmVxKSB7XG4gICAgY29uc3QgYm9keSA9IE9iamVjdC5hc3NpZ24oXG4gICAgICByZXEuYm9keSxcbiAgICAgIENsYXNzZXNSb3V0ZXIuSlNPTkZyb21RdWVyeShyZXEucXVlcnkpXG4gICAgKTtcbiAgICBjb25zdCBvcHRpb25zID0ge307XG5cbiAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhib2R5KSkge1xuICAgICAgaWYgKEFMTE9XRURfR0VUX1FVRVJZX0tFWVMuaW5kZXhPZihrZXkpID09PSAtMSkge1xuICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgUGFyc2UuRXJyb3IuSU5WQUxJRF9RVUVSWSxcbiAgICAgICAgICAnSW1wcm9wZXIgZW5jb2RlIG9mIHBhcmFtZXRlcidcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGJvZHkua2V5cyA9PT0gJ3N0cmluZycpIHtcbiAgICAgIG9wdGlvbnMua2V5cyA9IGJvZHkua2V5cztcbiAgICB9XG4gICAgaWYgKGJvZHkuaW5jbHVkZSkge1xuICAgICAgb3B0aW9ucy5pbmNsdWRlID0gU3RyaW5nKGJvZHkuaW5jbHVkZSk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgYm9keS5yZWFkUHJlZmVyZW5jZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIG9wdGlvbnMucmVhZFByZWZlcmVuY2UgPSBib2R5LnJlYWRQcmVmZXJlbmNlO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGJvZHkuaW5jbHVkZVJlYWRQcmVmZXJlbmNlID09PSAnc3RyaW5nJykge1xuICAgICAgb3B0aW9ucy5pbmNsdWRlUmVhZFByZWZlcmVuY2UgPSBib2R5LmluY2x1ZGVSZWFkUHJlZmVyZW5jZTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBib2R5LnN1YnF1ZXJ5UmVhZFByZWZlcmVuY2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICBvcHRpb25zLnN1YnF1ZXJ5UmVhZFByZWZlcmVuY2UgPSBib2R5LnN1YnF1ZXJ5UmVhZFByZWZlcmVuY2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3RcbiAgICAgIC5nZXQoXG4gICAgICAgIHJlcS5jb25maWcsXG4gICAgICAgIHJlcS5hdXRoLFxuICAgICAgICB0aGlzLmNsYXNzTmFtZShyZXEpLFxuICAgICAgICByZXEucGFyYW1zLm9iamVjdElkLFxuICAgICAgICBvcHRpb25zLFxuICAgICAgICByZXEuaW5mby5jbGllbnRTREtcbiAgICAgIClcbiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgaWYgKCFyZXNwb25zZS5yZXN1bHRzIHx8IHJlc3BvbnNlLnJlc3VsdHMubGVuZ3RoID09IDApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgICBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELFxuICAgICAgICAgICAgJ09iamVjdCBub3QgZm91bmQuJ1xuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUocmVxKSA9PT0gJ19Vc2VyJykge1xuICAgICAgICAgIGRlbGV0ZSByZXNwb25zZS5yZXN1bHRzWzBdLnNlc3Npb25Ub2tlbjtcblxuICAgICAgICAgIGNvbnN0IHVzZXIgPSByZXNwb25zZS5yZXN1bHRzWzBdO1xuXG4gICAgICAgICAgaWYgKHJlcS5hdXRoLnVzZXIgJiYgdXNlci5vYmplY3RJZCA9PSByZXEuYXV0aC51c2VyLmlkKSB7XG4gICAgICAgICAgICAvLyBGb3JjZSB0aGUgc2Vzc2lvbiB0b2tlblxuICAgICAgICAgICAgcmVzcG9uc2UucmVzdWx0c1swXS5zZXNzaW9uVG9rZW4gPSByZXEuaW5mby5zZXNzaW9uVG9rZW47XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7IHJlc3BvbnNlOiByZXNwb25zZS5yZXN1bHRzWzBdIH07XG4gICAgICB9KTtcbiAgfVxuXG4gIGhhbmRsZUNyZWF0ZShyZXEpIHtcbiAgICByZXR1cm4gcmVzdC5jcmVhdGUoXG4gICAgICByZXEuY29uZmlnLFxuICAgICAgcmVxLmF1dGgsXG4gICAgICB0aGlzLmNsYXNzTmFtZShyZXEpLFxuICAgICAgcmVxLmJvZHksXG4gICAgICByZXEuaW5mby5jbGllbnRTREtcbiAgICApO1xuICB9XG5cbiAgaGFuZGxlVXBkYXRlKHJlcSkge1xuICAgIGNvbnN0IHdoZXJlID0geyBvYmplY3RJZDogcmVxLnBhcmFtcy5vYmplY3RJZCB9O1xuICAgIHJldHVybiByZXN0LnVwZGF0ZShcbiAgICAgIHJlcS5jb25maWcsXG4gICAgICByZXEuYXV0aCxcbiAgICAgIHRoaXMuY2xhc3NOYW1lKHJlcSksXG4gICAgICB3aGVyZSxcbiAgICAgIHJlcS5ib2R5LFxuICAgICAgcmVxLmluZm8uY2xpZW50U0RLXG4gICAgKTtcbiAgfVxuXG4gIGhhbmRsZURlbGV0ZShyZXEpIHtcbiAgICByZXR1cm4gcmVzdFxuICAgICAgLmRlbChcbiAgICAgICAgcmVxLmNvbmZpZyxcbiAgICAgICAgcmVxLmF1dGgsXG4gICAgICAgIHRoaXMuY2xhc3NOYW1lKHJlcSksXG4gICAgICAgIHJlcS5wYXJhbXMub2JqZWN0SWQsXG4gICAgICAgIHJlcS5pbmZvLmNsaWVudFNES1xuICAgICAgKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICByZXR1cm4geyByZXNwb25zZToge30gfTtcbiAgICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIEpTT05Gcm9tUXVlcnkocXVlcnkpIHtcbiAgICBjb25zdCBqc29uID0ge307XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgXy5lbnRyaWVzKHF1ZXJ5KSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAganNvbltrZXldID0gSlNPTi5wYXJzZSh2YWx1ZSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGpzb25ba2V5XSA9IHZhbHVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4ganNvbjtcbiAgfVxuXG4gIHN0YXRpYyBvcHRpb25zRnJvbUJvZHkoYm9keSkge1xuICAgIGNvbnN0IGFsbG93Q29uc3RyYWludHMgPSBbXG4gICAgICAnc2tpcCcsXG4gICAgICAnbGltaXQnLFxuICAgICAgJ29yZGVyJyxcbiAgICAgICdjb3VudCcsXG4gICAgICAna2V5cycsXG4gICAgICAnZXhjbHVkZUtleXMnLFxuICAgICAgJ2luY2x1ZGUnLFxuICAgICAgJ2luY2x1ZGVBbGwnLFxuICAgICAgJ3JlZGlyZWN0Q2xhc3NOYW1lRm9yS2V5JyxcbiAgICAgICd3aGVyZScsXG4gICAgICAncmVhZFByZWZlcmVuY2UnLFxuICAgICAgJ2luY2x1ZGVSZWFkUHJlZmVyZW5jZScsXG4gICAgICAnc3VicXVlcnlSZWFkUHJlZmVyZW5jZScsXG4gICAgICAnaGludCcsXG4gICAgICAnZXhwbGFpbicsXG4gICAgXTtcblxuICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGJvZHkpKSB7XG4gICAgICBpZiAoYWxsb3dDb25zdHJhaW50cy5pbmRleE9mKGtleSkgPT09IC0xKSB7XG4gICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgICBQYXJzZS5FcnJvci5JTlZBTElEX1FVRVJZLFxuICAgICAgICAgIGBJbnZhbGlkIHBhcmFtZXRlciBmb3IgcXVlcnk6ICR7a2V5fWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3Qgb3B0aW9ucyA9IHt9O1xuICAgIGlmIChib2R5LnNraXApIHtcbiAgICAgIG9wdGlvbnMuc2tpcCA9IE51bWJlcihib2R5LnNraXApO1xuICAgIH1cbiAgICBpZiAoYm9keS5saW1pdCB8fCBib2R5LmxpbWl0ID09PSAwKSB7XG4gICAgICBvcHRpb25zLmxpbWl0ID0gTnVtYmVyKGJvZHkubGltaXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvcHRpb25zLmxpbWl0ID0gTnVtYmVyKDEwMCk7XG4gICAgfVxuICAgIGlmIChib2R5Lm9yZGVyKSB7XG4gICAgICBvcHRpb25zLm9yZGVyID0gU3RyaW5nKGJvZHkub3JkZXIpO1xuICAgIH1cbiAgICBpZiAoYm9keS5jb3VudCkge1xuICAgICAgb3B0aW9ucy5jb3VudCA9IHRydWU7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgYm9keS5rZXlzID09ICdzdHJpbmcnKSB7XG4gICAgICBvcHRpb25zLmtleXMgPSBib2R5LmtleXM7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgYm9keS5leGNsdWRlS2V5cyA9PSAnc3RyaW5nJykge1xuICAgICAgb3B0aW9ucy5leGNsdWRlS2V5cyA9IGJvZHkuZXhjbHVkZUtleXM7XG4gICAgfVxuICAgIGlmIChib2R5LmluY2x1ZGUpIHtcbiAgICAgIG9wdGlvbnMuaW5jbHVkZSA9IFN0cmluZyhib2R5LmluY2x1ZGUpO1xuICAgIH1cbiAgICBpZiAoYm9keS5pbmNsdWRlQWxsKSB7XG4gICAgICBvcHRpb25zLmluY2x1ZGVBbGwgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGJvZHkucmVhZFByZWZlcmVuY2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICBvcHRpb25zLnJlYWRQcmVmZXJlbmNlID0gYm9keS5yZWFkUHJlZmVyZW5jZTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBib2R5LmluY2x1ZGVSZWFkUHJlZmVyZW5jZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIG9wdGlvbnMuaW5jbHVkZVJlYWRQcmVmZXJlbmNlID0gYm9keS5pbmNsdWRlUmVhZFByZWZlcmVuY2U7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgYm9keS5zdWJxdWVyeVJlYWRQcmVmZXJlbmNlID09PSAnc3RyaW5nJykge1xuICAgICAgb3B0aW9ucy5zdWJxdWVyeVJlYWRQcmVmZXJlbmNlID0gYm9keS5zdWJxdWVyeVJlYWRQcmVmZXJlbmNlO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICBib2R5LmhpbnQgJiZcbiAgICAgICh0eXBlb2YgYm9keS5oaW50ID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgYm9keS5oaW50ID09PSAnb2JqZWN0JylcbiAgICApIHtcbiAgICAgIG9wdGlvbnMuaGludCA9IGJvZHkuaGludDtcbiAgICB9XG4gICAgaWYgKGJvZHkuZXhwbGFpbikge1xuICAgICAgb3B0aW9ucy5leHBsYWluID0gYm9keS5leHBsYWluO1xuICAgIH1cbiAgICByZXR1cm4gb3B0aW9ucztcbiAgfVxuXG4gIG1vdW50Um91dGVzKCkge1xuICAgIHRoaXMucm91dGUoJ0dFVCcsICcvY2xhc3Nlcy86Y2xhc3NOYW1lJywgcmVxID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmhhbmRsZUZpbmQocmVxKTtcbiAgICB9KTtcbiAgICB0aGlzLnJvdXRlKCdHRVQnLCAnL2NsYXNzZXMvOmNsYXNzTmFtZS86b2JqZWN0SWQnLCByZXEgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlR2V0KHJlcSk7XG4gICAgfSk7XG4gICAgdGhpcy5yb3V0ZSgnUE9TVCcsICcvY2xhc3Nlcy86Y2xhc3NOYW1lJywgcmVxID0+IHtcbiAgICAgIHJldHVybiB0aGlzLmhhbmRsZUNyZWF0ZShyZXEpO1xuICAgIH0pO1xuICAgIHRoaXMucm91dGUoJ1BVVCcsICcvY2xhc3Nlcy86Y2xhc3NOYW1lLzpvYmplY3RJZCcsIHJlcSA9PiB7XG4gICAgICByZXR1cm4gdGhpcy5oYW5kbGVVcGRhdGUocmVxKTtcbiAgICB9KTtcbiAgICB0aGlzLnJvdXRlKCdERUxFVEUnLCAnL2NsYXNzZXMvOmNsYXNzTmFtZS86b2JqZWN0SWQnLCByZXEgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlRGVsZXRlKHJlcSk7XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ2xhc3Nlc1JvdXRlcjtcbiJdfQ==